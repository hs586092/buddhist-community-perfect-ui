# 🇰🇷 Buddhist Community Korea - Amplify 빌드 설정
# 한국 시장 특화 + 비용 최적화

version: 1

# 백엔드 단계
backend:
  phases:
    build:
      commands:
        - '# 한국 전용 백엔드 배포'
        - amplifyPush --simple

# 프론트엔드 단계
frontend:
  phases:
    preBuild:
      commands:
        - echo "🇰🇷 Buddhist Community Korea 빌드 시작"
        - echo "Node version:"
        - node --version
        - echo "NPM version:"
        - npm --version
        - '# 한국 전용 환경 설정'
        - echo "AWS_DEFAULT_REGION=ap-northeast-2" >> .env
        - echo "VITE_TARGET_COUNTRY=KR" >> .env
        - echo "VITE_DEFAULT_LANGUAGE=ko" >> .env
        - echo "VITE_TIMEZONE=Asia/Seoul" >> .env
        - echo "VITE_CURRENCY=KRW" >> .env
        - echo "한국 전용 종속성 설치 중..."
        - npm ci
    build:
      commands:
        - echo "🏛️ 한국어 최적화 빌드 시작..."
        - npm run build:korea
        - echo "빌드 완료, dist 폴더 확인..."
        - ls -la dist/
        - echo "Index.html 내용:"
        - head -10 dist/index.html
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# 환경별 설정
environments:
  prod:
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - echo "VITE_APP_STAGE=production" >> .env
            - echo "VITE_TARGET_COUNTRY=KR" >> .env
            - echo "VITE_DEFAULT_LANGUAGE=ko" >> .env
        build:
          commands:
            - npm run build:korea
  dev:
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - echo "VITE_APP_STAGE=development" >> .env
            - echo "VITE_TARGET_COUNTRY=KR" >> .env
        build:
          commands:
            - npm run build:korea

# 사용자 정의 헤더 (보안 + 성능)
customHeaders:
  - pattern: '**'
    headers:
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'
  - pattern: '*.html'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=0, must-revalidate'
  - pattern: 'static/js/*.js'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  - pattern: 'static/css/*.css'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'