# ğŸª· Buddhist Community - ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Deploy Buddhist Community to AWS Amplify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸª· ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ›ï¸ ë¶ˆêµ ì»¤ë®¤ë‹ˆí‹° ë¹Œë“œ ì‹œì‘..."
        npm ci
        
    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ (í˜„ì¬ í…ŒìŠ¤íŠ¸ ì—†ìŒ)"
        # npm test -- --coverage --watchAll=false
        
    - name: ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ
      run: |
        echo "ğŸŒ¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ìƒì„± ì¤‘..."
        npm run build
        
    - name: ğŸ“Š ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ë¹Œë“œ ì™„ë£Œ! dist í´ë” ë‚´ìš©:"
        ls -la dist/
        echo "index.html í¬ê¸°:"
        wc -c dist/index.html
        echo "_redirects íŒŒì¼ í™•ì¸:"
        cat dist/_redirects
        
    - name: ğŸš€ AWS Amplify ë°°í¬
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2  # ì„œìš¸ ë¦¬ì „
        
    - name: ğŸ“¤ Amplify ì•± ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸª· Amplify ë°°í¬ ì¤‘..."
        aws amplify start-job \
          --app-id ${{ secrets.AMPLIFY_APP_ID }} \
          --branch-name main \
          --job-type RELEASE
          
    - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ Buddhist Community ë°°í¬ ì™„ë£Œ!"
        echo "URL: https://${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com"
        
  lighthouse:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com
          https://${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com/temple-reviews
          https://${{ secrets.AMPLIFY_APP_ID }}.amplifyapp.com/community
        uploadArtifacts: true
        temporaryPublicStorage: true